# Memory - 2026-01-30

## Cron Optimization - Option C Implementation (02:05 UTC / 9:05 PM EST Jan 29)

**Context:** Yesterday's docs deep-dive revealed I was using cron/heartbeat wrong. Discussed three approaches with Shirin.

**Decision:** Option C (Hybrid) - batch flexible checks in heartbeat, keep scheduled deliverables as cron.

**Changes made:**
1. **Removed cron jobs (3 total):**
   - `gmail-scan` (1 AM) - Removed entirely per Shirin's request
   - `daily-security-report` (10 AM) - Moved to heartbeat (flexible timing)
   - `system-cleanup-logging` (2:30 AM) - Moved to heartbeat (flexible timing)

2. **Added cron job:**
   - `improvement-analysis` (4:30 AM EST) - Generates daily improvement proposals before morning brief

3. **Rewrote HEARTBEAT.md:**
   - Clear "when to act vs stay silent" section
   - Specific triggers for each check (no vague "every 3-4 hours")
   - Security monitoring: Check logs, alert if >50 SSH failures or unusual activity
   - System maintenance: Check disk/memory, auto-cleanup when safe
   - Overnight autonomous work: 1-5 AM window, pick task, work 30-90 min
   - Memory review: Use CLI tools, merge fragments
   - Self-review: Document mistakes, track failure modes

4. **Updated CRON.json** to reflect current state (13 jobs remaining)

**Result:**
- 3 fewer cron jobs (16 â†’ 13)
- More flexible security/system checks (runs when heartbeat polls vs fixed time)
- Clearer heartbeat logic (no more "every 3-4 hours" ambiguity)
- Improvement analysis now feeds morning brief automatically

**Git commit:** d87229c

**Token savings:** ~2-3 API calls/day (batching security + system checks in one heartbeat turn)

**Next in fixing things I was doing wrong:**
- [x] ~~Memory search discipline~~ âœ… DONE
- [ ] Memory writing automation  
- [ ] Model fallback config (when API keys ready)
- [ ] Session freshness (suggest /new more)

---

#cron-optimization #heartbeat #token-efficiency

## Memory Search Discipline - Implemented (02:15 UTC / 9:15 PM EST Jan 29)

**Problem:** Not using `memory_search` before answering questions about prior work, decisions, dates, or re-reading files. Wasting tokens.

**Solution implemented:**

1. **Added mandatory search rules to AGENTS.md:**
   - Clear triggers: prior work, decisions, dates, people, preferences, todos
   - Search-first pattern: `memory_search` â†’ `memory_get` â†’ answer
   - Honesty rule: never pretend to search if you didn't
   - Indexing caveat: async, recent changes might not appear immediately

2. **Created examples doc:** `/root/clawd/docs/memory-search-examples.md`
   - Good vs bad response patterns
   - When to search, when not to search
   - Token efficiency comparison (92% savings for targeted recall)
   - Anti-patterns to avoid

3. **Tested current state:**
   - Memory search is configured: `sessionMemory: true`, sources: memory + sessions
   - Currently returning empty (async indexing not caught up yet)
   - Pattern still valid: search first, fall back to file read if empty

**Token savings potential:**
- Without search: ~3300 tokens (read MEMORY.md + daily files)
- With search: ~250 tokens (query + targeted section)
- **Savings: 92% for targeted recall**

**Next:** Memory writing automation (write + commit immediately after significant events)

**Git commit:** 4255551

---

#memory-search #token-efficiency #discipline

## DeepSeek API Configuration - Complete (02:13 UTC / 9:13 PM EST Jan 29)

**API key stored:** `/root/.env` (secure, not in git, 600 permissions)

**Config applied:**
1. Added `deepseek:default` auth profile
2. Created custom provider `deepseek` with OpenAI-compatible API
3. Models registered:
   - `deepseek-chat` (64K context, 8K max tokens)
   - `deepseek-reasoner` (R1 model, 64K context)
4. Alias created: `deepseek` â†’ `deepseek/deepseek-chat`
5. Fallback chain: `claude-sonnet-4-5` â†’ `deepseek/deepseek-chat`

**Tested:**
- API key validated âœ…
- Models visible via API âœ…
- Gateway restarted successfully âœ…

**How fallback works:**
- Primary: Claude Sonnet 4.5
- On rate limit/auth failure/billing issues: Auto-switches to DeepSeek
- Automatic cooldown + exponential backoff
- Cooldown state: `~/.clawdbot/agents/<agentId>/agent/auth-profiles.json`

**Cost comparison:**
- Claude: ~$3 / 1M input, ~$15 / 1M output
- DeepSeek: ~$0.14 / 1M input, ~$0.28 / 1M output
- **Savings: ~95% cheaper on fallback**

**Next in "things I was doing wrong":**
- [x] ~~Model fallback config~~ âœ… DONE
- [x] ~~Memory writing automation~~ âœ… DONE

---

#deepseek #model-fallback #cost-optimization

## Memory Writing Automation - Implemented (02:17 UTC / 9:17 PM EST Jan 29)

**Problem:** Not writing to memory immediately after significant actions. Batching changes, taking "mental notes" that don't persist, replying before documenting.

**Solution implemented:**

1. **Created comprehensive checklist:** `/root/clawd/docs/CHECKLIST-memory-writing.md`
   - 6 trigger categories: Build/Create, Configuration, Learning, Tasks, Decisions, Mistakes
   - Clear pattern: Do â†’ Write â†’ Commit â†’ Reply (in that order)
   - Memory file structure template
   - No exceptions: "Write it now" for everything significant

2. **Built enforcement script:** `/root/clawd/scripts/memory-check.sh`
   - Checks if today's memory file exists
   - Warns if last modified >30 minutes ago
   - Detects uncommitted memory changes
   - Can be run during self-review to enforce discipline

3. **Updated AGENTS.md:**
   - Added explicit triggers (6 categories)
   - Reinforced pattern: Do â†’ Write â†’ Commit â†’ Reply
   - Reference to full checklist

4. **Updated HEARTBEAT.md:**
   - Added memory writing discipline to self-review checklist
   - Included memory-check.sh in self-review process
   - Track delayed writes as failure mode

**Files created:**
- `/root/clawd/docs/CHECKLIST-memory-writing.md` - Full trigger checklist
- `/root/clawd/scripts/memory-check.sh` - Enforcement script (executable)

**Files modified:**
- `AGENTS.md` - Added triggers and pattern
- `HEARTBEAT.md` - Added memory check to self-review

**The rule:**
```
Do the action â†’ Write to memory â†’ Commit â†’ THEN reply
```

**Never:**
- âŒ "I'll document this later"
- âŒ Batch multiple changes
- âŒ Reply first, write later
- âŒ Take "mental notes"

**Always:**
- âœ… Write immediately (context fresh)
- âœ… Commit immediately (persist)
- âœ… Be specific (commands, paths, outcomes)
- âœ… Include tags

**Next in "things I was doing wrong":**
- [x] ~~Cron optimization~~ âœ…
- [x] ~~Memory search discipline~~ âœ…
- [x] ~~Model fallback config~~ âœ…
- [x] ~~Memory writing automation~~ âœ…
- [x] ~~Session freshness~~ âœ… DONE

**Git commit:** 22aa8a2

---

#memory-discipline #automation #enforcement

## Session Freshness - Implemented (02:22 UTC / 9:22 PM EST Jan 29)

**Problem:** Not suggesting `/new` when sessions get too long, leading to:
- High token usage (context window fills up)
- Slow responses (more tokens to process)
- Memory fragmentation
- Context dilution

**Solution implemented:**

1. **Created guidelines:** `/root/clawd/docs/SESSION-FRESHNESS.md`
   - 4 trigger categories: Token threshold, Time-based, Topic shift, Performance issues
   - Clear thresholds: >50% context (nudge), >75% context (recommend), >8h age (suggest)
   - How to check: `ðŸ“Š session_status`
   - When NOT to suggest (active deep dive, quick follow-ups)

2. **Updated AGENTS.md:**
   - Added session freshness to startup checklist
   - Added monitoring section with triggers and benefits
   - Reference to full guidelines

3. **Updated HEARTBEAT.md:**
   - Added session freshness to self-review checklist
   - Specific checks: context > 75%, age > 8h, compactions > 2
   - Track stale sessions as failure mode

**Benefits of fresh sessions:**
- **Performance:** Faster responses, lower token usage
- **User experience:** Clean slate for new topics, no context bleed
- **System health:** Prevents context overflow, reduces compaction

**Current session status (for reference):**
- Context: 66k/1.0m (7%) - Healthy
- Compactions: 1 - Normal
- Session age: ~1 minute (fresh)

**All "things I was doing wrong" now fixed:**
1. âœ… Cron optimization (Option C - hybrid approach)
2. âœ… Memory search discipline (search-first pattern)
3. âœ… Model fallback config (DeepSeek API + fallback chain)
4. âœ… Memory writing automation (enforcement system)
5. âœ… Session freshness (proactive /new suggestions)

**Git commit:** 0c14005

---

#session-freshness #performance #context-management
